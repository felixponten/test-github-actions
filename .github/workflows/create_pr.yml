name: Create pr

permissions:
  contents: write
  pull-requests: write
  actions: write

on:
  workflow_dispatch:

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create changes and new branch
        run: |
          # Configure git
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          # Create and switch to a new branch called "new-feature"
          git checkout -b new-feature
          # Make some changes (e.g., create a new file)
          echo "This is an automatically generated file." > newfile.txt
          # Stage and commit changes
          git add newfile.txt
          git commit -m "Add newfile.txt with automated content" || echo "No changes to commit"

      - name: Push new branch to origin
        run: git push origin new-feature


      - name: Create PR from master to develop
        run: |
          PR_URL=$(gh pr create --base beta --head new-feature --title "Auto Merge a to b" --body "Automated PR")
          PR_NUMBER=$(gh pr view $PR_URL --json number -q .number)
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
         
      # Wait for unit tests to pass before merging (example)
      - name: Wait for unit tests to pass
        run: |
          PR_STATUS=$(gh pr view $PR_NUMBER --json checks -q '.checks[0].status')
          while [[ "$PR_STATUS" != "SUCCESS" && "$PR_STATUS" != "FAILURE" ]]; do
            echo "Waiting for status check to pass..."
            sleep 10
            PR_STATUS=$(gh pr view $PR_NUMBER --json checks -q '.checks[0].status')
          done
          if [[ "$PR_STATUS" == "FAILURE" ]]; then
            echo "Unit tests failed. Exiting."
            exit 1
          fi
          echo "Unit tests passed. Proceeding."
